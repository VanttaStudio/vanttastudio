---
import { Icon } from "astro-icon/components";
import { getLangFromUrl, getUrlWithoutLang, useTranslations, useTranslatedPath } from "@i18n/utils";

const lang = getLangFromUrl(Astro.url);
const path = getUrlWithoutLang(Astro.url);
const t = useTranslations(lang);
const translatePath = useTranslatedPath(lang);

const pages = [
    {
        title: t("Home") || "Home",
        url: "/",
    },
    {
        // Forzamos "Portafolio" en español y "Portfolio" en inglés
        title: lang === "es" ? "Portafolio" : "Portfolio",
        url: "/work/",
    },
    {
        title: "Blog",
        url: "/blog/",
    },
    {
        title: t("contacts") || "Contact",
        url: "/contact/",
    },
];

const { pathname } = Astro.url;
---

<header class="relative z-[100]">
    <a href={translatePath("/")} aria-label="Home" class="logo absolute left-0 top-0 z-[110] flex h-[4.5rem] items-center px-8 md:h-[5.9rem]">
        <svg
            version="1.1"
            xmlns="http://www.w3.org/2000/svg"
            viewBox="0 0 2809.6 545.3"
            class="logo-svg h-7 w-36 md:h-9"
            fill="none"
            stroke="currentColor"
            stroke-width="12">
            <path d="M81.3,373.8v-184c0-3.4,0.3-6.7,0.9-10c3.2-18.1,17.5-69.5,77.3-78.8c0,0,43.7-5.5,76.9,27.7c0.5,0.5,0.5,1.3,0,1.8 L202.7,164c-0.5,0.5-1.3,0.5-1.8,0c-3-3.1-14.1-12.8-35.6-12.8c-24.6,0-32.5,28.4-33.1,30.8c0,0.1-0.1,0.2-0.1,0.3v185.1 c0,0.1,0,0.3,0.1,0.4c0.9,2.4,9.4,23.5,35,23.6h0.1c0.8,0.1,15.6,0.9,29.8-13.4l66.5-67.2c0.1-0.1,0.1-0.1,0.1-0.2 c0.5-0.8,2.9-5.1,3.6-12.6c0-0.1,0-0.1,0-0.1v-51.6c0-2.8-0.8-5.5-2.4-7.9c-2.4-3.6-7.5-10.3-11.9-14.2c-0.5-0.5-0.6-1.3-0.1-1.8 l35.3-35.3c0.4-0.4,1.2-0.5,1.7-0.1c5,4.1,29.5,25.9,29.5,54.6v66.2c0,2-0.2,3.9-0.7,5.9c-1.6,6.2-6.5,19.7-21.3,34.5L216,429.5 c-2.6,2.6-5.8,4.9-9.2,6.5c-12.2,5.6-42.5,16.1-76.9,0.5h-0.1c-1-0.4-28.7-11.1-46.5-51.4C82.1,381.5,81.3,377.7,81.3,373.8z"></path>
            <path d="M404.5,171.5v184.1c0,3.4-0.3,6.7-0.9,10c-3.2,18.1-17.5,69.5-77.3,78.8c0,0-43.7,5.5-76.9-27.7c-0.5-0.5-0.5-1.3,0-1.8 l33.5-33.5c0.5-0.5,1.3-0.5,1.8,0c3,3.1,14.1,12.8,35.6,12.8c24.6,0,32.5-28.4,33.1-30.8c0-0.1,0.1-0.2,0.1-0.3V178 c0-0.1,0-0.3-0.1-0.4c-0.9-2.4-9.4-23.5-35-23.6h-0.1c-0.8-0.1-15.6-0.9-29.8,13.4L222,234.6c-0.1,0.1-0.1,0.1-0.1,0.2 c-0.5,0.8-2.9,5.1-3.6,12.6c0,0.1,0,0.1,0,0.1v51.6c0,2.8,0.8,5.5,2.4,7.9c2.4,3.6,7.5,10.3,11.9,14.2c0.5,0.5,0.6,1.3,0.1,1.8 l-35.3,35.3c-0.4,0.4-1.2,0.5-1.7,0.1c-5-4.1-29.5-25.9-29.5-54.6v-66.2c0-2,0.2-3.9,0.7-5.9c1.6-6.2,6.5-19.7,21.3-34.5l81.4-81.4 c2.6-2.6,5.8-4.9,9.2-6.5c12.2-5.6,42.5-16.1,76.9-0.5h0.1c1,0.4,28.7,11.1,46.5,51.4C403.6,163.8,404.5,167.6,404.5,171.5z"></path>
        </svg>
    </a>

    <div x-data="{ open: false }" class="navigation fixed right-0 top-0 z-[100] p-6" :class="{'w-full h-screen bg-zinc-950/95 backdrop-blur-2xl': open}">
        <div class="ml-auto transition-all duration-500 md:max-w-fit" :class="open ? 'max-w-full' : 'max-w-[12rem]'">
            <div class="nav-container group relative overflow-hidden rounded-3xl border border-zinc-800 bg-zinc-900/80 backdrop-blur-md transition-all duration-500 shadow-2xl">
                
                <div class="flex items-center justify-end p-3 md:hidden">
                    <button @click="open = !open" class="flex h-10 w-10 items-center justify-center rounded-full bg-zinc-800 text-white transition-transform" :class="{'rotate-90': open}">
                        <svg x-show="!open" class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
                        <svg x-show="open" class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>
                </div>

                <nav :class="open ? 'flex' : 'hidden'" class="flex-col p-8 md:flex md:flex-row md:items-center md:p-2">
                    <ul class="flex list-none flex-col gap-4 md:flex-row md:items-center md:gap-1">
                        {pages.map((page) => {
                            const translatedUrl = translatePath(page.url);
                            // La lógica isActive detecta si estamos en el index o en una subpágina de work o blog
                            const isActive = pathname === translatedUrl || 
                                           (page.url === "/blog/" && pathname.includes("/blog")) ||
                                           (page.url === "/work/" && pathname.includes("/work"));
                            
                            return (
                                <li data-cursor-hover>
                                    <a href={translatedUrl} class={`group relative block rounded-full px-6 py-3 transition-all md:px-4 md:py-2 ${isActive ? 'bg-zinc-800' : 'hover:bg-lime-400'}`}>
                                        <span class={`text-2xl font-bold uppercase tracking-widest transition-colors md:text-xs ${isActive ? 'text-lime-400' : 'text-zinc-400 group-hover:text-black'}`}>
                                            {page.title}
                                        </span>
                                    </a>
                                </li>
                            );
                        })}
                        
                        <li class="mt-4 border-t border-zinc-800 pt-4 md:ml-2 md:mt-0 md:border-l md:border-t-0 md:pl-2 md:pt-0">
                            <a href={translatePath(path, lang === "es" ? "en" : "es")} class="flex items-center justify-center rounded-full bg-zinc-800 px-4 py-2 text-[10px] font-black text-lime-400 hover:bg-white hover:text-black transition-all">
                                {lang === "es" ? "EN" : "ES"}
                            </a>
                        </li>
                    </ul>
                </nav>
            </div>
        </div>
    </div>
</header>

<style>
    .logo { mix-blend-mode: difference; color: white; }
    .nav-container { transform-origin: right top; }
</style>

<script>
    import { gsap } from "gsap";
    import { ScrollTrigger } from "gsap/ScrollTrigger";
    import { DrawSVGPlugin } from "gsap/DrawSVGPlugin";

    gsap.registerPlugin(DrawSVGPlugin, ScrollTrigger);

    function init() {
        const logoTl = gsap.timeline({ defaults: { duration: 1.5, ease: "expo.out" }});
        
        logoTl.from(".logo-svg path", { 
            drawSVG: 0, 
            stagger: 0.1 
        })
        .to(".logo-svg path", { 
            fill: "#a3e635", 
            stroke: "transparent", 
            duration: 1 
        }, "-=0.5");

        const navContainer = document.querySelector(".nav-container");
        const navLinks = document.querySelector("nav ul");

        if (window.innerWidth >= 768 && navContainer) {
            let menuCollapseTl = gsap.timeline({ paused: true })
                .to(navContainer, { width: "50px", duration: 0.4, ease: "power4.inOut" })
                .to(navLinks, { opacity: 0, pointerEvents: "none", duration: 0.2 }, "<");

            const onScroll = () => {
                if (window.scrollY > 100) menuCollapseTl.play();
                else menuCollapseTl.reverse();
            };

            window.addEventListener("scroll", onScroll);
            navContainer.addEventListener("mouseenter", () => menuCollapseTl.reverse());
            navContainer.addEventListener("mouseleave", () => {
                if (window.scrollY > 100) menuCollapseTl.play();
            });
        }
    }

    document.addEventListener("astro:page-load", init);
</script>